name: ci

on:
  push:
    branches: [ main, refactoring ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      run_e2e:
        description: 'Run end-to-end tests?'
        required: false
        default: 'true'

permissions:
  contents: read

jobs:
  test:
    name: Test and Build cr8s-fe
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      CI: true
      
    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸ³ Log in to GitHub Container Registry
        run: echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: ğŸš€ Run quickstart with full lint checks
        run: ./scripts/quickstart.sh --full-lint
        
      - name: ğŸ§° Set up Node.js for Playwright
        if: github.event.inputs.run_e2e == 'true' || github.event_name != 'workflow_dispatch'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: ğŸ“¦ Install NPM dependencies  
        if: github.event.inputs.run_e2e == 'true' || github.event_name != 'workflow_dispatch'
        run: npm install
        
      - name: ğŸ­ Install Playwright browsers
        if: github.event.inputs.run_e2e == 'true' || github.event_name != 'workflow_dispatch'
        run: npx playwright install --with-deps
        
      - name: âœ… Run Playwright E2E tests (login only)
        if: github.event.inputs.run_e2e == 'true' || github.event_name != 'workflow_dispatch'
        run: npx playwright test tests/playwright/login.spec.ts
        
      - name: ğŸ“‹ Upload test results on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/
          
      - name: ğŸ›‘ Cleanup services
        if: always()
        run: |
          echo "ğŸ›‘ Shutting down services..."
          docker compose down -v || true
